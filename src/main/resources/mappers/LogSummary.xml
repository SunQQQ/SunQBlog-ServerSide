<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sunquanBlog.mapper.LogSummaryMapper">
    <resultMap id="Log" type="com.sunquanBlog.model.LogSummary">
        <id column="id" property="id"/>
        <result column="ip" property="ip"/>
        <result column="page" property="page"/>
        <result column="city" property="city"/>
        <result column="create_time" property="createTime"/>
        <result column="browser" property="browser"/>
        <result column="platform" property="platform"/>
        <result column="user_id" property="userId"/>
        <result column="entry_time" property="entryTime"/>
        <result column="leave_time" property="leaveTime"/>
        <result column="visit_day" property="visitDay"/>
        <result column="pv" property="pv"/>
    </resultMap>

    <!-- 获取'当天'的访问IP及用户类型（新用户/老用户) -->
    <select id="getTodayOldUser" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            a.ip,
            CASE
                WHEN EXISTS (
                        SELECT 1
                        FROM log_daily_ip_summary b
                        WHERE
                            b.ip = a.ip
                          AND b.visit_day < CURDATE()
                    )
                    THEN '老用户'
                ELSE '新用户' END AS user_type
        FROM (
                 SELECT DISTINCT ip FROM log
                 WHERE create_time >= CURDATE()
                   AND create_time < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
             ) a
        ]]>
    </select>

    <!-- 获取一段时间内的访问IP及用户类型（新用户/老用户）,即day>0
    比如10号的近3天，包含10、9、8号，不包含7号当天，所以应该是10-2 -->
    <select id="getOldUser" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            a.ip,
            CASE
                WHEN EXISTS (
                        SELECT 1
                        FROM log_daily_ip_summary b
                        WHERE
                            b.ip = a.ip
                          AND b.visit_day < DATE_SUB(CURDATE(), INTERVAL (#{days}-1) DAY)
                    )
                    THEN '老用户'
                ELSE '新用户' END AS user_type
        FROM (
                 SELECT DISTINCT ip FROM log
                 WHERE create_time > DATE_SUB(CURDATE(), INTERVAL (#{days}-1) DAY)
                   AND create_time < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
             ) a
        ]]>
    </select>

    <select id="getTodayPlatformRatio" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            platform,
            count(1) total
        FROM
            log_daily_ip_summary
        WHERE
            create_time >= CURDATE()
            AND create_time < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
        GROUP BY
            platform
        ]]>
    </select>

    <select id="getPlatformRatio" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            platform,
            count(1) total
        FROM
            log_daily_ip_summary
        WHERE
            create_time > DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
            AND create_time < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
        GROUP BY
            platform
        ]]>
    </select>
</mapper>