<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sunquanBlog.mapper.LogSummaryMapper">
    <resultMap id="Log" type="com.sunquanBlog.model.LogSummary">
        <id column="id" property="id"/>
        <result column="ip" property="ip"/>
        <result column="page" property="page"/>
        <result column="city" property="city"/>
        <result column="create_time" property="createTime"/>
        <result column="browser" property="browser"/>
        <result column="platform" property="platform"/>
        <result column="user_id" property="userId"/>
        <result column="entry_time" property="entryTime"/>
        <result column="leave_time" property="leaveTime"/>
        <result column="visit_day" property="visitDay"/>
        <result column="pv" property="pv"/>
    </resultMap>

    <!-- 获取'当天'的访问IP及用户类型（新用户/老用户) -->
    <select id="getTodayOldUser" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            a.ip,
            CASE
                WHEN EXISTS (
                        SELECT 1
                        FROM log_daily_ip_summary b
                        WHERE
                            b.ip = a.ip
                          AND b.visit_day < CURDATE()
                    )
                    THEN '老用户'
                ELSE '新用户' END AS user_type
        FROM (
                 SELECT DISTINCT ip FROM log_daily_ip_summary
                 WHERE visit_day >= CURDATE()
                   AND visit_day < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
             ) a
        ]]>
    </select>

    <!-- 获取一段时间内的访问IP及用户类型（新用户/老用户）,即day>0
    比如10号的近3天，包含10、9、8号，不包含7号当天，所以应该是10-2 -->
    <select id="getOldUser" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            a.ip,
            CASE
                WHEN EXISTS (
                        SELECT 1
                        FROM log_daily_ip_summary b
                        WHERE
                            b.ip = a.ip
                          AND b.visit_day < DATE_SUB(CURDATE(), INTERVAL (#{days}-1) DAY)
                    )
                    THEN '老用户'
                ELSE '新用户' END AS user_type
        FROM (
                 SELECT DISTINCT ip FROM log_daily_ip_summary
                 WHERE visit_day >= DATE_SUB(CURDATE(), INTERVAL (#{days}-1) DAY)
                   AND visit_day < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
             ) a
        ]]>
    </select>

    <select id="getTodayPlatformRatio" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            platform,
            count(1) total
        FROM
            log_daily_ip_summary
        WHERE
            visit_day >= CURDATE()
            AND visit_day < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
        GROUP BY
            platform
        ]]>
    </select>

    <select id="getPlatformRatio" resultType="java.util.LinkedHashMap">
        <![CDATA[
        SELECT
            platform,
            count(1) total
        FROM
            log_daily_ip_summary
        WHERE
            visit_day >= DATE_SUB(CURDATE(), INTERVAL (#{days}-1) DAY)
            AND visit_day < DATE_ADD(CURDATE(), INTERVAL 1 DAY)
        GROUP BY
            platform
        ]]>
    </select>

    <delete id="deleteToday">
        DELETE FROM log_daily_ip_summary
        where visit_day = CURDATE()
    </delete>

    <insert id="insertDailyIpSummary">
        <![CDATA[
        INSERT INTO log_daily_ip_summary (
            visit_day, ip, page, city, browser, user_action,
            platform, user_id, entry_time, leave_time, pv, create_time
        )
        SELECT
            #{visitDay} AS visit_day,
            ip,
            GROUP_CONCAT(DISTINCT page) AS page,
            GROUP_CONCAT(DISTINCT ip_city) AS city,
            GROUP_CONCAT(DISTINCT browser) AS browser,
            GROUP_CONCAT(
                CONCAT(`action`, action_object, action_desc)
                ORDER BY create_time
                SEPARATOR '+'
            ) AS user_action,
            GROUP_CONCAT(DISTINCT platform_type) AS platform,
            GROUP_CONCAT(DISTINCT CASE WHEN user_id > 0 THEN user_id END) AS user_id,
            MIN(create_time) AS entry_time,
            MAX(create_time) AS leave_time,
            COUNT(*) AS pv,
            now() create_time
        FROM `log`
        WHERE
            create_time >= #{startTime}
            AND create_time < #{endTime}
            ${excludeIpsSql}
        GROUP BY ip
        ON DUPLICATE KEY UPDATE
            page = VALUES(page),
            city = VALUES(city),
            browser = VALUES(browser),
            user_action = VALUES(user_action),
            platform = VALUES(platform),
            user_id = VALUES(user_id),
            entry_time = VALUES(entry_time),
            leave_time = VALUES(leave_time),
            pv = VALUES(pv)
        ]]>
    </insert>

    <delete id="cleanAll">
        TRUNCATE TABLE log_daily_ip_summary
    </delete>

    <select id="getTodayIp" resultType="java.util.Map">
        select
            count(*) as todayIpCount,
            coalesce(sum(pv),0) as todayPvCount
        from
            log_daily_ip_summary
        where
            create_time >= curdate()
    </select>

    <select id="getTotalIp" resultType="java.util.Map">
        select
            count(*) as totalIpCount,
            coalesce(sum(pv),0) as totalPvCount
        from
            log_daily_ip_summary
    </select>
</mapper>